<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="containo.us">
        
        <link rel="shortcut icon" href="img/traefik.icon.png">
        

	<title>Swarm mode cluster - Træfɪk</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="../../css/traefik.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Træfɪk</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Getting Started</a>
                </li>
            
            
            
                <li >
                    <a href="../../basics/">Basics</a>
                </li>
            
            
            
                <li >
                    <a href="../../toml/">traefik.toml</a>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../examples/">Configuration examples</a>
</li>

                    
                        
<li >
    <a href="../swarm/">Swarm cluster</a>
</li>

                    
                        
<li class="active">
    <a href="./">Swarm mode cluster</a>
</li>

                    
                        
<li >
    <a href="../kubernetes/">Kubernetes</a>
</li>

                    
                        
<li >
    <a href="../kv-config/">Key-value store configuration</a>
</li>

                    
                        
<li >
    <a href="../cluster/">Clustering/HA</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li >
                    <a href="../../benchmarks/">Benchmarks</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../swarm/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../kubernetes/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/containous/traefik">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#docker-swarm-mode-cluster">Docker Swarm (mode) cluster</a></li>
        
            <li><a href="#prerequisites">Prerequisites</a></li>
        
            <li><a href="#cluster-provisioning">Cluster provisioning</a></li>
        
            <li><a href="#deploy-trfik">Deploy Træfik</a></li>
        
            <li><a href="#deploy-your-apps">Deploy your apps</a></li>
        
            <li><a href="#access-to-your-apps-through-trfk">Access to your apps through Træfɪk</a></li>
        
            <li><a href="#scale-both-services">Scale both services</a></li>
        
            <li><a href="#access-to-your-whoami0-through-trfk-multiple-times">Access to your whoami0 through Træfɪk multiple times.</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="docker-swarm-mode-cluster">Docker Swarm (mode) cluster</h1>
<p>This section explains how to create a multi-host docker cluster with
swarm mode using <a href="https://docs.docker.com/machine">docker-machine</a> and
how to deploy Træfɪk on it.</p>
<p>The cluster consists of:</p>
<ul>
<li>3 servers</li>
<li>1 manager</li>
<li>2 workers</li>
<li>1 <a href="https://docs.docker.com/engine/userguide/networking/dockernetworks/#an-overlay-network">overlay</a> network
(multi-host networking)</li>
</ul>
<h2 id="prerequisites">Prerequisites</h2>
<ol>
<li>You will need to install <a href="https://docs.docker.com/machine/">docker-machine</a></li>
<li>You will need the latest <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a></li>
</ol>
<h2 id="cluster-provisioning">Cluster provisioning</h2>
<p>First, let's create all the required nodes. It's a shorter version of
the <a href="https://docs.docker.com/engine/swarm/swarm-tutorial/">swarm tutorial</a>.</p>
<pre><code class="sh">docker-machine create -d virtualbox manager
docker-machine create -d virtualbox worker1
docker-machine create -d virtualbox worker2
</code></pre>

<p>Then, let's setup the cluster, in order :</p>
<ol>
<li>initialize the cluster</li>
<li>get the token for other host to join</li>
<li>on both workers, join the cluster with the token</li>
</ol>
<pre><code class="sh">docker-machine ssh manager &quot;docker swarm init \
    --listen-addr $(docker-machine ip manager) \
    --advertise-addr $(docker-machine ip manager)&quot;

export worker_token=$(docker-machine ssh manager &quot;docker swarm \
join-token worker -q&quot;)

docker-machine ssh worker1 &quot;docker swarm join \
    --token=${worker_token} \
    --listen-addr $(docker-machine ip worker1) \
    --advertise-addr $(docker-machine ip worker1) \
    $(docker-machine ip manager)&quot;

docker-machine ssh worker2 &quot;docker swarm join \
    --token=${worker_token} \
    --listen-addr $(docker-machine ip worker2) \
    --advertise-addr $(docker-machine ip worker2) \
    $(docker-machine ip manager)&quot;
</code></pre>

<p>Let's validate the cluster is up and running.</p>
<pre><code class="sh">docker-machine ssh manager docker node ls
ID                           HOSTNAME  STATUS  AVAILABILITY  MANAGER STATUS
2a770ov9vixeadep674265u1n    worker1   Ready   Active
dbi3or4q8ii8elbws70g4hkdh *  manager   Ready   Active        Leader
esbhhy6vnqv90xomjaomdgy46    worker2   Ready   Active
</code></pre>

<p>Finally, let's create a network for Træfik to use.</p>
<pre><code class="sh">docker-machine ssh manager &quot;docker network create --driver=overlay traefik-net&quot;
</code></pre>

<h2 id="deploy-trfik">Deploy Træfik</h2>
<p>Let's deploy Træfik as a docker service in our cluster. The only
requirement for Træfik to work with swarm mode is that it needs to run
on a manager node — we are going to use a
<a href="https://docs.docker.com/engine/reference/commandline/service_create/#/specify-service-constraints-constraint">constraint</a> for
that.</p>
<pre><code>docker-machine ssh manager &quot;docker service create \
    --name traefik \
    --constraint=node.role==manager \
    --publish 80:80 --publish 8080:8080 \
    --mount type=bind,source=/var/run/docker.sock,target=/var/run/docker.sock \
    --network traefik-net \
    traefik \
    --docker \
    --docker.swarmmode \
    --docker.domain=traefik \
    --docker.watch \
    --web&quot;
</code></pre>

<p>Let's explain this command:</p>
<ul>
<li><code>--publish 80:80 --publish 8080:8080</code>: we publish port <code>80</code> and
  <code>8080</code> on the cluster.</li>
<li><code>--constraint=node.role==manager</code>: we ask docker to schedule Træfik
  on a manager node.</li>
<li><code>--mount type=bind,source=/var/run/docker.sock,target=/var/run/docker.sock</code>:
  we bind mount the docker socket where Træfik is scheduled to be able
  to speak to the daemon.</li>
<li><code>--network traefik-net</code>: we attach the Træfik service (and thus
  the underlying container) to the <code>traefik-net</code> network.</li>
<li><code>--docker</code>: enable docker backend, and <code>--docker.swarmmode</code> to
  enable the swarm mode on Træfik.</li>
<li><code>--web</code>: activate the webUI on port 8080</li>
</ul>
<h2 id="deploy-your-apps">Deploy your apps</h2>
<p>We can now deploy our app on the cluster,
here <a href="https://github.com/emilevauge/whoami">whoami</a>, a simple web
server in Go. We start 2 services, on the <code>traefik-net</code> network.</p>
<pre><code class="sh">docker-machine ssh manager &quot;docker service create \
    --name whoami0 \
    --label traefik.port=80 \
    --network traefik-net \
    emilevauge/whoami&quot;

docker-machine ssh manager &quot;docker service create \
    --name whoami1 \
    --label traefik.port=80 \
    --network traefik-net \
    --label traefik.backend.loadbalancer.sticky=true \
    emilevauge/whoami&quot;
</code></pre>

<p>Note that we set whoami1 to use sticky sessions (<code>--label traefik.backend.loadbalancer.sticky=true</code>).  We'll demonstrate that later.
If using <code>docker stack deploy</code>, there is <a href="https://github.com/containous/traefik/issues/994#issuecomment-269095109">a specific way that the labels must be defined in the docker-compose file</a>.</p>
<p>Check that everything is scheduled and started:</p>
<pre><code class="sh">docker-machine ssh manager &quot;docker service ls&quot;
ID            NAME     REPLICAS  IMAGE              COMMAND
ab046gpaqtln  whoami0  1/1       emilevauge/whoami
cgfg5ifzrpgm  whoami1  1/1       emilevauge/whoami
dtpl249tfghc  traefik  1/1       traefik            --docker --docker.swarmmode --docker.domain=traefik --docker.watch --web
</code></pre>

<h2 id="access-to-your-apps-through-trfk">Access to your apps through Træfɪk</h2>
<pre><code class="sh">curl -H Host:whoami0.traefik http://$(docker-machine ip manager)
Hostname: 8147a7746e7a
IP: 127.0.0.1
IP: ::1
IP: 10.0.9.3
IP: fe80::42:aff:fe00:903
IP: 172.18.0.3
IP: fe80::42:acff:fe12:3
GET / HTTP/1.1
Host: 10.0.9.3:80
User-Agent: curl/7.35.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: 192.168.99.1
X-Forwarded-Host: 10.0.9.3:80
X-Forwarded-Proto: http
X-Forwarded-Server: 8fbc39271b4c

curl -H Host:whoami1.traefik http://$(docker-machine ip manager)
Hostname: ba2c21488299
IP: 127.0.0.1
IP: ::1
IP: 10.0.9.4
IP: fe80::42:aff:fe00:904
IP: 172.18.0.2
IP: fe80::42:acff:fe12:2
GET / HTTP/1.1
Host: 10.0.9.4:80
User-Agent: curl/7.35.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: 192.168.99.1
X-Forwarded-Host: 10.0.9.4:80
X-Forwarded-Proto: http
X-Forwarded-Server: 8fbc39271b4c
</code></pre>

<p>Note that as Træfik is published, you can access it from any machine
and not only the manager.</p>
<pre><code class="sh">curl -H Host:whoami0.traefik http://$(docker-machine ip worker1)
Hostname: 8147a7746e7a
IP: 127.0.0.1
IP: ::1
IP: 10.0.9.3
IP: fe80::42:aff:fe00:903
IP: 172.18.0.3
IP: fe80::42:acff:fe12:3
GET / HTTP/1.1
Host: 10.0.9.3:80
User-Agent: curl/7.35.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: 192.168.99.1
X-Forwarded-Host: 10.0.9.3:80
X-Forwarded-Proto: http
X-Forwarded-Server: 8fbc39271b4c

curl -H Host:whoami1.traefik http://$(docker-machine ip worker2)
Hostname: ba2c21488299
IP: 127.0.0.1
IP: ::1
IP: 10.0.9.4
IP: fe80::42:aff:fe00:904
IP: 172.18.0.2
IP: fe80::42:acff:fe12:2
GET / HTTP/1.1
Host: 10.0.9.4:80
User-Agent: curl/7.35.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: 192.168.99.1
X-Forwarded-Host: 10.0.9.4:80
X-Forwarded-Proto: http
X-Forwarded-Server: 8fbc39271b4c
</code></pre>

<h2 id="scale-both-services">Scale both services</h2>
<pre><code class="sh">docker-machine ssh manager &quot;docker service scale whoami0=5&quot;

docker-machine ssh manager &quot;docker service scale whoami1=5&quot;
</code></pre>

<p>Check that we now have 5 replicas of each <code>whoami</code> service:</p>
<pre><code class="sh">docker-machine ssh manager &quot;docker service ls&quot;
ID            NAME     REPLICAS  IMAGE              COMMAND
ab046gpaqtln  whoami0  5/5       emilevauge/whoami
cgfg5ifzrpgm  whoami1  5/5       emilevauge/whoami
dtpl249tfghc  traefik  1/1       traefik            --docker --docker.swarmmode --docker.domain=traefik --docker.watch --web
</code></pre>

<h2 id="access-to-your-whoami0-through-trfk-multiple-times">Access to your whoami0 through Træfɪk multiple times.</h2>
<p>Repeat the following command multiple times and note that the Hostname changes each time as Traefik load balances each request against the 5 tasks.</p>
<pre><code class="sh">curl -H Host:whoami0.traefik http://$(docker-machine ip manager)
Hostname: 8147a7746e7a
IP: 127.0.0.1
IP: ::1
IP: 10.0.9.3
IP: fe80::42:aff:fe00:903
IP: 172.18.0.3
IP: fe80::42:acff:fe12:3
GET / HTTP/1.1
Host: 10.0.9.3:80
User-Agent: curl/7.35.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: 192.168.99.1
X-Forwarded-Host: 10.0.9.3:80
X-Forwarded-Proto: http
X-Forwarded-Server: 8fbc39271b4c
</code></pre>

<p>Do the same against whoami1.  </p>
<pre><code class="sh">curl -H Host:whoami1.traefik http://$(docker-machine ip manager)
Hostname: ba2c21488299
IP: 127.0.0.1
IP: ::1
IP: 10.0.9.4
IP: fe80::42:aff:fe00:904
IP: 172.18.0.2
IP: fe80::42:acff:fe12:2
GET / HTTP/1.1
Host: 10.0.9.4:80
User-Agent: curl/7.35.0
Accept: */*
Accept-Encoding: gzip
X-Forwarded-For: 192.168.99.1
X-Forwarded-Host: 10.0.9.4:80
X-Forwarded-Proto: http
X-Forwarded-Server: 8fbc39271b4c
</code></pre>

<p>Wait, I thought we added the sticky flag to whoami1?  Traefik relies on a cookie to maintain stickyness so you'll need to test this with a browser.</p>
<p>First you need to add whoami1.traefik to your hosts file:</p>
<pre><code class="ssh">if [ -n &quot;$(grep whoami1.traefik /etc/hosts)&quot; ];  
then 
echo &quot;whoami1.traefik already exists (make sure the ip is current)&quot;; 
else 
sudo -- sh -c -e &quot;echo '$(docker-machine ip manager)\twhoami1.traefik' 
&gt;&gt; /etc/hosts&quot;; 
fi
</code></pre>

<p>Now open your browser and go to http://whoami1.traefik/</p>
<p>You will now see that stickyness is maintained.</p>
<p><img alt="" src="http://i.giphy.com/ujUdrdpX7Ok5W.gif" /></p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
                <center>Copyright &copy; 2016 Containous SAS</center>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../theme/js/structor-menu.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>